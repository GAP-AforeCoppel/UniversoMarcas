<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base de Conocimiento de Marcas | GAP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'Fira Code', monospace; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #1d4ed8; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #fbbF24; }
        
        .brand-card { transition: all 0.2s ease-in-out; display: flex; flex-direction: column; height: 100%; }
        .brand-card:hover { transform: translateY(-4px); }
        
        .nav-button.active { background-color: #1d4ed8; color: white; box-shadow: 0 4px 12px rgba(29, 78, 216, 0.3); }
        .dark .nav-button.active { background-color: #fbbF24; color: #111827; box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3); }

        .area-tab.active { background-color: #1d4ed8; color: white; }
        .dark .area-tab.active { background-color: #fbbF24; color: #111827; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.3s ease-out forwards; }
        
        .pulse-query { animation: pulse-blue 2s infinite; }
        .pulse-proceso { animation: pulse-amber 2s infinite; }
        .pulse-ti { animation: pulse-indigo 2s infinite; }
        .pulse-pdf { animation: pulse-red 2s infinite; }

        @keyframes pulse-blue { 0% { box-shadow: 0 0 0 0 rgba(29, 78, 216, 0.4); } 70% { box-shadow: 0 0 0 8px rgba(29, 78, 216, 0); } 100% { box-shadow: 0 0 0 0 rgba(29, 78, 216, 0); } }
        @keyframes pulse-amber { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); } 70% { box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }
        @keyframes pulse-indigo { 0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); } 70% { box-shadow: 0 0 0 8px rgba(79, 70, 229, 0); } 100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); } 70% { box-shadow: 0 0 0 8px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }

        .proceso-content h3 { font-weight: 800; font-size: 1.1rem; color: #1e3a8a; margin-top: 1.5rem; margin-bottom: 0.75rem; border-left: 4px solid #f59e0b; padding-left: 0.75rem; }
        .dark .proceso-content h3 { color: #fbbF24; }
        .proceso-content ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        .proceso-content li { margin-bottom: 0.5rem; }
        .proceso-highlight { background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2); padding: 1rem; border-radius: 1rem; margin-top: 1rem; }
        b { font-weight: 700; color: inherit; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">

    <!-- Modal SQL -->
    <div id="query-modal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-gray-800 w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300" id="query-modal-content">
            <div class="p-6 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center text-blue-600">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 7v10c0 2.21 3.58 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.58 4 8 4s8-1.79 8-4M4 7c0-2.21 3.58-4 8-4s8 1.79 8 4m0 5c0 2.21-3.58 4-8 4s-8-1.79-8-4"></path></svg></div>
                    <div><h2 class="text-xl font-bold dark:text-white" id="query-title">Query</h2><span id="server-badge" class="text-[10px] font-black bg-blue-600 text-white px-2 py-0.5 rounded uppercase mt-1 inline-block">Servidor: SAFRE</span></div>
                </div>
                <button onclick="closeModal('query-modal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="p-6 bg-gray-50 dark:bg-gray-900">
                <div class="relative group">
                    <pre class="font-mono text-sm p-6 bg-gray-900 text-green-400 rounded-2xl overflow-x-auto border border-gray-700 shadow-inner max-h-[400px]" id="query-text"></pre>
                    <button id="copy-query-btn" onclick="window.copyToClipboard()" class="absolute top-4 right-4 bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-xl text-xs font-bold transition-all border border-white/10 shadow-lg"><span id="copy-btn-text">Copiar Query</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Proceso -->
    <div id="proceso-modal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-gray-800 w-full max-w-3xl rounded-3xl shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300" id="proceso-modal-content">
            <div class="p-6 border-b border-amber-100 dark:border-amber-900/30 flex justify-between items-center bg-amber-50/50 dark:bg-amber-900/10 text-amber-600">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-amber-100 dark:bg-amber-900/30 rounded-lg shadow-inner"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg></div>
                    <h2 class="text-xl font-bold dark:text-white" id="proceso-title">Desarrollo</h2>
                </div>
                <button onclick="closeModal('proceso-modal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="p-8 max-h-[70vh] overflow-y-auto proceso-content text-gray-700 dark:text-gray-300" id="proceso-text"></div>
            <div class="p-6 border-t border-gray-100 dark:border-gray-700 text-right bg-gray-50 dark:bg-gray-800/50">
                <button onclick="closeModal('proceso-modal')" class="px-8 py-2.5 bg-amber-500 hover:bg-amber-600 text-white font-bold rounded-xl transition-all shadow-lg">Entendido</button>
            </div>
        </div>
    </div>

    <!-- Modal TI -->
    <div id="ti-modal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-gray-800 w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300" id="ti-modal-content">
            <div class="p-6 border-b border-indigo-100 dark:border-indigo-900/30 flex justify-between items-center bg-indigo-50 dark:bg-indigo-900/10 text-indigo-600">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-indigo-600 rounded-lg shadow-lg text-white font-black text-xs uppercase">TI</div>
                    <h2 class="text-xl font-bold dark:text-white">Oferta de Ticket</h2>
                </div>
                <button onclick="closeModal('ti-modal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="p-8">
                <div class="mb-6"><h5 class="text-[10px] font-black text-indigo-600 uppercase mb-2">Ticket a levantar:</h5><p class="text-2xl font-black text-gray-900 dark:text-white" id="ti-offer-name"></p></div>
                <div class="p-5 bg-gray-50 dark:bg-gray-900/50 rounded-2xl border border-gray-100 dark:border-gray-700 mb-8"><h5 class="text-[10px] font-black text-gray-400 uppercase mb-3 uppercase">Ruta del Ticket:</h5><p class="text-sm font-bold text-gray-700 dark:text-gray-300 flex flex-wrap items-center gap-2" id="ti-path"></p></div>
                <div class="text-center">
                    <h5 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-4">Imagen de Referencia:</h5>
                    <div class="inline-block p-2 bg-white dark:bg-gray-700 rounded-2xl shadow-md border border-gray-100 dark:border-gray-600">
                        <img id="ti-image" src="" alt="Referencia TI" class="rounded-xl max-w-full h-auto max-h-[300px]">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal PDF -->
    <div id="pdf-modal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-gray-800 w-full max-w-xl rounded-3xl shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300" id="pdf-modal-content">
            <div class="p-6 border-b border-red-100 dark:border-red-900/30 flex justify-between items-center bg-red-50 dark:bg-red-900/10 text-red-600">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-red-600 rounded-lg shadow-lg text-white font-black"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg></div>
                    <h2 class="text-xl font-bold dark:text-white">Manual PDF</h2>
                </div>
                <button onclick="closeModal('pdf-modal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="p-10 text-center">
                <div class="w-20 h-20 bg-red-50 dark:bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-6 text-red-600"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div>
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2" id="pdf-manual-name">Manual</h3>
                <a id="pdf-download-link" href="#" download class="inline-flex items-center gap-2 px-8 py-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-2xl shadow-xl active:scale-95">Descargar PDF</a>
            </div>
            <div class="p-4 bg-gray-50 dark:bg-gray-900/50 text-center text-[10px] text-gray-400 uppercase font-bold tracking-widest italic">Documento de apoyo interno - Elaborado por UNE/GAP</div>
        </div>
    </div>

    <!-- Login -->
    <div id="gatekeeper" class="fixed inset-0 z-50 bg-gray-100 dark:bg-gray-900 flex flex-col items-center justify-center p-4 transition-opacity duration-500">
        <div class="max-w-md w-full bg-white dark:bg-gray-800 rounded-3xl shadow-2xl p-10 text-center border border-gray-200 dark:border-gray-700">
            <img src="logoafore.png" alt="Afore Coppel" class="h-20 mx-auto mb-8 drop-shadow-sm">
            <h1 class="text-3xl font-bold text-blue-900 dark:text-yellow-400 mb-2 font-black uppercase tracking-tight text-center">Acceso Seguro</h1>
            <p class="text-gray-500 dark:text-gray-400 mb-8 text-sm italic text-center">Ingresa la clave de acceso para continuar</p>
            <input type="password" id="access-key" class="w-full px-6 py-4 bg-gray-50 dark:bg-gray-700 border-none rounded-2xl focus:ring-4 focus:ring-blue-500/20 text-center text-xl tracking-[0.5em] outline-none mb-4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <button id="auth-btn" class="w-full py-4 bg-blue-700 hover:bg-blue-800 text-white font-bold rounded-2xl shadow-xl transition-all active:scale-95 uppercase tracking-widest text-sm">Entrar al Sistema</button>
            <div id="auth-error" class="hidden mt-4 p-3 bg-red-50 text-red-600 rounded-xl text-xs font-bold animate-fade">Clave incorrecta o error de conexi√≥n.</div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app-content" class="hidden opacity-0 transition-opacity duration-700 min-h-screen">
        <nav class="bg-white dark:bg-gray-800 shadow-md py-4 sticky top-0 z-40">
            <div class="max-w-[1920px] mx-auto px-6 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <img src="logoafore.png" alt="Logo Afore Coppel" class="h-10">
                    <div class="border-l border-gray-300 dark:border-gray-600 h-8"></div>
                    <img src="logogap.png" alt="Logo Gerencia" class="w-16">
                </div>
                <div class="flex items-center gap-3">
                    <button id="seed-btn" class="p-2.5 bg-blue-50 text-blue-600 rounded-xl text-[10px] font-black uppercase tracking-tighter shadow-sm border border-blue-100 hover:bg-blue-100 transition-all">Sincronizar Firebase</button>
                    <button id="toggle-dark" class="p-2.5 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-all"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0z"></path></svg></button>
                </div>
            </div>
        </nav>

        <header class="relative text-center bg-cover bg-center shadow-xl overflow-hidden py-24 md:py-48 lg:py-64 mb-10" style="background-image: url('cafe.png'); background-color: #1e3a8a;">
            <div class="absolute inset-0 bg-blue-900 bg-opacity-75"></div>
            <div class="relative z-10 px-6 max-w-5xl mx-auto text-white">
                <h1 class="text-3xl sm:text-5xl font-black dark:text-yellow-300 tracking-tight uppercase text-center">Base de Conocimiento de Marcas</h1>
                <p class="text-lg text-blue-100 mt-2 font-medium italic text-center">Gu√≠a integral dirigida a CAT, MSO y UNE/GAP</p>
            </div>
        </header>

        <div class="max-w-[1920px] mx-auto px-6 pb-20">
            <div class="max-w-5xl mx-auto mb-10 text-center">
                <div class="relative mb-6">
                    <input type="text" id="search-input" class="w-full bg-white dark:bg-gray-800 shadow-xl rounded-2xl py-5 pl-14 pr-4 text-lg focus:ring-4 focus:ring-blue-500/20 border-none outline-none transition-all placeholder:text-gray-400" placeholder="Buscar marcas...">
                    <svg class="w-6 h-6 absolute left-5 top-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <div id="filters" class="flex flex-wrap justify-center gap-3">
                    <button data-cat="all" class="nav-button active py-2 px-8 rounded-xl bg-white dark:bg-gray-800 shadow font-bold text-xs uppercase transition-all">Todas</button>
                    <button data-cat="OPERATIVA" class="nav-button py-2 px-8 rounded-xl bg-white dark:bg-gray-800 shadow font-bold text-xs uppercase text-red-600 transition-all">Operativas</button>
                    <button data-cat="INFORMATIVA" class="nav-button py-2 px-8 rounded-xl bg-white dark:bg-gray-800 shadow font-bold text-xs uppercase text-green-600 transition-all">Informativas</button>
                </div>
            </div>
            <main id="brands-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6 items-start"></main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, getDoc, doc, setDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- CONFIGURACI√ìN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDsNnGym8K_noUMIdpWYhfXWOe4NkuUJ-M",
            authDomain: "universomarcas-ad78c.firebaseapp.com",
            projectId: "universomarcas-ad78c",
            storageBucket: "universomarcas-ad78c.firebasestorage.app",
            messagingSenderId: "661272043721",
            appId: "1:661272043721:web:531bcb7185cfbd04296d18"
        };
        // ------------------------------

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'universomarcas-final';

        let marcasDB = [];
        let currentActiveQuery = '';

        function renderBrands(list) {
            const grid = document.getElementById('brands-grid');
            if (!grid) return;
            grid.innerHTML = list.length === 0 ? '<div class="col-span-full text-center py-20 opacity-50 font-black uppercase tracking-widest">Sin resultados</div>' : '';
            list.forEach((brand) => {
                const card = document.createElement('div');
                card.className = "brand-card bg-white dark:bg-gray-800 rounded-3xl shadow-md border border-gray-100 dark:border-gray-700 overflow-hidden animate-fade";
                const isSafre = brand.origen === "SAFRE";
                const sourceColor = isSafre ? "bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300" : "bg-purple-100 text-purple-700 dark:bg-purple-900/40 dark:text-purple-300";
                const isInformativa = brand.tipo === "INFORMATIVA";
                const typeColor = isInformativa ? "bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300" : "bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-300";
                const titleNum = (brand.clave && brand.clave !== "N/A") ? `<span class="text-blue-700 dark:text-yellow-500 mr-2 font-black">${brand.clave}</span>` : "";
                
                const qBtn = brand.query ? `<button onclick="window.openQueryModal('${brand.nombre}', \`${brand.query}\`, '${brand.servidor}')" class="p-2 bg-blue-600 text-white rounded-xl pulse-query" title="Ver Query SQL"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 7v10c0 2.21 3.58 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.58 4 8 4s8-1.79 8-4M4 7c0-2.21 3.58-4 8-4s8 1.79 8 4m0 5c0 2.21-3.58 4-8 4s-8-1.79-8-4"></path></svg></button>` : "";
                const pBtn = brand.proceso ? `<button onclick="window.openProcesoModal('${brand.nombre}', \`${brand.proceso}\`)" class="p-2 bg-amber-500 text-white rounded-xl pulse-proceso" title="Ver Contexto"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg></button>` : "";
                const tBtn = brand.ti ? `<button onclick="window.openTiModalByName('${brand.nombre}')" class="p-2 bg-indigo-600 text-white rounded-xl pulse-ti font-black text-[10px]">TI</button>` : "";
                const dBtn = brand.pdf ? `<button onclick="window.openPdfModalByName('${brand.nombre}')" class="p-2 bg-red-600 text-white rounded-xl pulse-pdf font-black text-[10px]">PDF</button>` : "";

                let actionHtml = '';
                if (brand.tipo === 'OPERATIVA' && brand.acciones) {
                    const sid = brand.nombre.replace(/[^a-zA-Z0-9]/g, '-');
                    actionHtml = `
                        <div class="mt-auto pt-4 border-t border-gray-100 dark:border-gray-700">
                            <div class="flex gap-1 mb-2 bg-gray-50 dark:bg-gray-900/50 p-1 rounded-xl">
                                <button onclick="window.switchArea(this, '${sid}', 'CAT', '${brand.nombre}')" class="area-tab active flex-1 py-1.5 text-[10px] font-bold rounded-lg transition-all">CAT</button>
                                <button onclick="window.switchArea(this, '${sid}', 'MSO', '${brand.nombre}')" class="area-tab flex-1 py-1.5 text-[10px] font-bold rounded-lg transition-all">MSO</button>
                                <button onclick="window.switchArea(this, '${sid}', 'UNE', '${brand.nombre}')" class="area-tab flex-1 py-1.5 text-[10px] font-bold rounded-lg transition-all">UNE/GAP</button>
                            </div>
                            <div class="bg-blue-50/50 dark:bg-blue-900/10 p-4 rounded-xl min-h-[100px] flex items-start border border-blue-100 dark:border-blue-900/30 overflow-y-auto">
                                <p id="action-text-${sid}" class="text-[11px] italic font-medium text-gray-700 dark:text-gray-200 animate-fade">"${brand.acciones.CAT}"</p>
                            </div>
                        </div>`;
                }

                card.innerHTML = `
                    <div class="p-5 flex-grow flex flex-col">
                        <div class="flex flex-wrap justify-between items-start gap-2 mb-3">
                            <div class="flex gap-2"><span class="text-[9px] font-black px-2 py-1 rounded-lg ${sourceColor} uppercase tracking-widest font-black">${brand.origen}</span><span class="text-[9px] font-black px-2 py-1 rounded-lg ${typeColor} uppercase tracking-widest font-black">${brand.tipo}</span></div>
                            <span class="text-[9px] font-bold text-gray-400 uppercase tracking-tighter">${brand.plazo}</span>
                        </div>
                        <div class="flex justify-between items-start gap-2 mb-2">
                            <h3 class="text-base font-bold text-blue-900 dark:text-yellow-400 leading-tight uppercase flex-grow">${titleNum}${brand.nombre}</h3>
                            <div class="flex gap-1">${qBtn}${pBtn}${tBtn}${dBtn}</div>
                        </div>
                        <p class="text-[11px] text-gray-600 dark:text-gray-400 leading-normal mb-4">${brand.descripcion}</p>
                        ${actionHtml}
                    </div>`;
                grid.appendChild(card);
            });
        }

        // Global functions
        window.openQueryModal = (n, q, s) => { currentActiveQuery = q; document.getElementById('query-title').innerText = n; document.getElementById('query-text').innerText = q; document.getElementById('server-badge').innerText = `Servidor: ${s}`; const m = document.getElementById('query-modal'); m.classList.replace('hidden', 'flex'); setTimeout(() => { m.classList.add('opacity-100'); document.getElementById('query-modal-content').classList.replace('scale-95', 'scale-100'); }, 10); };
        window.openProcesoModal = (n, h) => { document.getElementById('proceso-title').innerText = n; document.getElementById('proceso-text').innerHTML = h; const m = document.getElementById('proceso-modal'); m.classList.replace('hidden', 'flex'); setTimeout(() => { m.classList.add('opacity-100'); document.getElementById('proceso-modal-content').classList.replace('scale-95', 'scale-100'); }, 10); };
        window.openTiModalByName = (n) => { const b = marcasDB.find(x => x.nombre === n); if (!b?.ti) return; document.getElementById('ti-offer-name').innerText = b.ti.titulo; const parts = b.ti.ruta.split(' ¬ª '); document.getElementById('ti-path').innerHTML = parts.map((p, i) => `<span>${p}</span>${i < parts.length - 1 ? '<svg class="w-3 h-3 text-indigo-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"></path></svg>' : ''}`).join(''); document.getElementById('ti-image').src = b.ti.imagen; const m = document.getElementById('ti-modal'); m.classList.replace('hidden', 'flex'); setTimeout(() => { m.classList.add('opacity-100'); document.getElementById('ti-modal-content').classList.replace('scale-95', 'scale-100'); }, 10); };
        window.openPdfModalByName = (n) => { const b = marcasDB.find(x => x.nombre === n); if (!b?.pdf) return; document.getElementById('pdf-manual-name').innerText = b.nombre; document.getElementById('pdf-download-link').href = b.pdf.enlace; const m = document.getElementById('pdf-modal'); m.classList.replace('hidden', 'flex'); setTimeout(() => { m.classList.add('opacity-100'); document.getElementById('pdf-modal-content').classList.replace('scale-95', 'scale-100'); }, 10); };
        window.closeModal = (id) => { const m = document.getElementById(id); const c = document.getElementById(id + '-content'); m.classList.remove('opacity-100'); c.classList.replace('scale-100', 'scale-95'); setTimeout(() => m.classList.replace('flex', 'hidden'), 300); };
        window.copyToClipboard = () => { const ta = document.createElement('textarea'); ta.value = currentActiveQuery; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); const btn = document.getElementById('copy-btn-text'); btn.innerText = '¬°Copiado!'; setTimeout(() => btn.innerText = 'Copiar Query', 2000); };
        window.switchArea = (btn, sid, a, name) => { btn.parentElement.querySelectorAll('button').forEach(x => x.classList.remove('active')); btn.classList.add('active'); const b = marcasDB.find(x => x.nombre === name); const k = a === 'UNE' ? 'UNE' : a; document.getElementById(`action-text-${sid}`).innerHTML = `"${b.acciones[k]}"`; };

        async function seedFirebase() {
            const btn = document.getElementById('seed-btn');
            btn.innerText = 'Sincronizando...';
            
            const data = [
                // --- SAFRE ---
                { clave: "120", nombre: "INHABILITACI√ìN POR TRASP.", origen: "SAFRE", tipo: "OPERATIVA", plazo: "Indefinido", descripcion: "Se coloca cuando el trabajador se traspas√≥ a otra Afore.", acciones: { CAT: "Mencionar al trabajador que su cuenta se encuentra inhabilitada derivado de un servicio de traspaso realizado y canalizarlo a su Afore actual para consultar el estatus.", MSO: "Levantar CRM si presenta una situaci√≥n especial, de lo contrario la marca es correcta.", UNE: "Validar si es correcta la Marca y canalizar al trabajador a su Afore actual." } },
                { clave: "140", nombre: "INHABILITACI√ìN POR RETIRO", origen: "SAFRE", tipo: "OPERATIVA", plazo: "Indefinido", descripcion: "La cuenta se queda en $0 por realizar un Retiro Total.", acciones: { CAT: "Informar al trabajador que su cuenta est√° inhabilitada debido a un servicio de retiro total. Si la cuenta individual del trabajador presenta esta marca y a√∫n tiene saldos, se debe levantar consulta mediante un folio CRM.", MSO: "En caso de que la cuenta del trabajador cuente con saldos, es necesario solicitar el desmarque mediante un folio CRM.", UNE: "Si la marca es incorrecta, solicitar desmarque con el √°rea de retiros totales." } },
                { clave: "151", nombre: "CUENTA SALDO CERO", origen: "SAFRE", tipo: "OPERATIVA", plazo: "Indefinido", descripcion: "Se apertura la cuenta y no se reciben aportaciones.", acciones: { CAT: "Sondear al trabajador si ha recibido aportaciones patronales posteriores al 1ro de Julio de 1997. En caso de requerir una aclaraci√≥n de saldos o presentar saldos en la cuenta, levantar consulta CRM.", MSO: "Si el asesor indica que el trabajador tiene aportaciones pero no tiene saldo en la cuenta, se debe levantar un CRM. En este caso, si se dispone del reporte de semanas cotizadas, se debe anexar al folio.", UNE: "Si no hay saldo disponible, es necesario realizar un an√°lisis para confirmar la procedencia. En caso de ser as√≠, se debe generar una consulta con el √°rea de Recaudaci√≥n." } },
                { clave: "160", nombre: "INHABILITACI√ìN POR SALDO CERO", origen: "SAFRE", tipo: "OPERATIVA", plazo: "Indefinido", descripcion: "Cuando se apertura una cuenta y no se recibe aportaci√≥n en por lo menos 6 bimestres.", ti: { titulo: "ELIMINAR MARCA SAFRE", ruta: "Quiero pedir algo ¬ª Mesa de Servicios BackOffice Afore ¬ª UNE ¬ª Atenci√≥n al P√∫blico", imagen: "ofertamarca160.PNG" }, acciones: { CAT: "Sondear al trabajador si ha recibido aportaciones patronales posteriores al 1ro de Julio del 1997. En caso de requerir una aclaraci√≥n de saldos o presenta saldos en la cuenta, levantar consulta CRM.", MSO: "Si el asesor indica que el trabajador tiene aportaciones pero no tiene saldo en la cuenta, se debe levantar un CRM. En este caso, si se dispone del reporte de semanas cotizadas, se debe anexar al folio.", UNE: "Si no hay saldo disponible, es necesario realizar un an√°lisis para confirmar la procedencia. En caso de ser as√≠, se debe generar una consulta con el √°rea de Recaudaci√≥n." } },
                { clave: "234", nombre: "ANUALIDADES GARANTIZADAS", origen: "SAFRE", tipo: "INFORMATIVA", plazo: "Duraci√≥n del Cr√©dito", descripcion: "Se Marca cuando el trabajador cuenta con cr√©dito de vivienda y queda hasta que haya terminado el cr√©dito." },
                { clave: "235", nombre: "PROCESO DE ANUALIDADES GARANTIZADAS", origen: "SAFRE", tipo: "OPERATIVA", plazo: "1 Mes", descripcion: "Se coloca cuando el instituto lo notifica y dura aproximadamente un mes.", acciones: { CAT: "Sin acci√≥n a seguir, mencionar al trabajador que su cuenta se encuentra en un proceso Operativo con el instituto de Vivienda.", MSO: "Sin acci√≥n a seguir, trabajador se encuentra en proceso con el instituto de Vivienda.", UNE: "Sin acci√≥n a seguir, mencionar al trabajador que su cuenta se encuentra en un proceso Operativo con el instituto de Vivienda." } },
                { clave: "258", nombre: "TRANSFERENCIA FONDO BIENESTAR", origen: "SAFRE", tipo: "OPERATIVA", plazo: "Indefinido", descripcion: "Se coloca cuando se realiza la Transferencia de Recursos al FONDO BIENESTAR", proceso: "<h3>üìë 1. Casos que S√ç atendemos en Afore (CRM)</h3><p>Si el trabajador presenta alguna de estas situaciones, procedemos a realizar la solicitud de devoluci√≥n generando el CRM correspondiente:</p><ul><li>Proceso de Unificaci√≥n de cuentas. üìÇ</li><li>Separaci√≥n de cuentas. ‚úÇÔ∏è</li><li>Tr√°mite Judicial en curso. ‚öñÔ∏è</li></ul><h3>üèõÔ∏è 2. Casos gestionados por el Instituto (IMSS/ISSSTE)</h3><p>En los siguientes escenarios, la Afore ya no inicia el proceso:</p><ul><li>Si el trabajador ya tiene resoluci√≥n (derecho cargado): El Instituto ser√° el encargado de detonar la devoluci√≥n autom√°ticamente. ‚úÖ</li><li>Si el trabajador NO tiene resoluci√≥n: debemos dirigir al trabajador al Instituto correspondiente. üö©</li></ul>", acciones: { CAT: "Sondear al trabajador si ya realiz√≥ la solicitud de devoluci√≥n de recurso transferidos al fondo de pensiones bienestar, en caso de no ser as√≠, canalizarlo a ventanilla correspondiente.", MSO: "Si la devoluci√≥n de todas las subcuentas ya ha sido efectuada, se debe generar un folio CRM para solicitar el desmarque.", UNE: "Validar si ya se realiz√≥ la devoluci√≥n de los saldos en las subcuentas correspondientes, de ser as√≠, solicitar el desmarque con Traspasos A-A." } },
                { clave: "268", nombre: "CANDIDATO DE UNIFICACI√ìN MIXTA", origen: "SAFRE", tipo: "OPERATIVA", plazo: "Indefinido", descripcion: "Se identifica CURP duplicada en BDSAR.", pdf: { titulo: "Unificaci√≥n de Cuentas MIXTA.pdf", enlace: "Unificaci√≥n de Cuentas MIXTA.pdf" }, proceso: "<div class='proceso-highlight font-bold mb-4 text-blue-900 dark:text-blue-200'>üìå Para acci√≥n a seguir UNE/GAP</div><p>A continuaci√≥n, se presenta un resumen estructurado sobre Unificaci√≥n de Cuentas MIXTA:</p><h3>üìÇ Tipos</h3><ul><li>Misma persona con <b>CURP duplicada</b> en <b>BDNSAR (PROCESAR)</b>.</li><li><b>MIXTA ISSSTE - IMSS:</b> Trabajador con registro por CURP en ISSSTE y registro de NSS.</li></ul><h3>üîç Candidato</h3><ul><li>MARCA en Consulta 0101 de PROCESAR.</li><li>Campo <b>CURPDUPLICADO</b> con indicador 1.</li></ul>", acciones: { CAT: "Generar una consulta en el CRM para la aclaraci√≥n de la marca operativa.", MSO: "Es necesario iniciar el proceso de Unificaci√≥n Mixta. En caso de no permitir realizar el servicio, levantar folio CRM.", UNE: "Realizar el an√°lisis de la cuenta para validar si es candidato y realizar las consultas correspondientes. (Ver Manual PDF adjunto)." } },
                { clave: "301", nombre: "TES RCV", origen: "SAFRE", tipo: "OPERATIVA", plazo: "2 d√≠as h√°biles", descripcion: "La marca 301 se coloca cuando la cuenta participa en la transferencia entre Sociedades de Inversi√≥n (SIEFORE).", proceso: "<h3>üîÑ Proceso de Transferencia (SIEFORE)</h3><p>Participa en transferencia regulada entre Sociedades de Inversi√≥n:</p><ul><li><b>üìä Estrategia:</b> Basada en inversi√≥n y perfil de edad del cotizante. üìà</li><li><b>üí∞ Objetivo:</b> Optimizar rentabilidad moviendo activos a la SIEFORE que mejor se adapte. üè¶</li></ul>", acciones: { CAT: "Sin acci√≥n a seguir, informar que su cuenta est√° participando en un proceso de transferencia entre SIEFORES.", MSO: "Sin acci√≥n a seguir, la cuenta del trabajador se encuentra en transferencia de recursos entre SIEFORES.", UNE: "Sin acci√≥n a seguir, informar que su cuenta est√° participando en un proceso de transferencia entre SIEFORES." } },
                { clave: "490", nombre: "RETIRO DE APORTACIONES VOLUNTARIAS", origen: "SAFRE", tipo: "OPERATIVA", plazo: "5 d√≠as h√°biles", descripcion: "Servicio para disponer de recursos ahorrados de forma adicional.", proceso: "<h3>üí∞ Servicio de Retiro de Ahorro Voluntario</h3><ul><li>ü™™ ID Vigente.</li><li>üß¨ Expediente Bio actualizado.</li><li>üìù Solicitud formal ante Afore.</li></ul>", acciones: { CAT: "Validar plazo normativo. Consultar estatus. Si no se encuentra, levantar consulta CRM.", MSO: "Validar si ya se cumpli√≥ el plazo normativo, en caso de ser as√≠, levantar consulta CRM para el desmarque.", UNE: "En caso de haberse cumplido el tiempo normativo, solicitar el desmarque con el √°rea de retiros parciales." } },
                { clave: "921", nombre: "CONSULTA SALDO PREVIO", origen: "SAFRE", tipo: "OPERATIVA", plazo: "30 d√≠as h√°biles", descripcion: "Trabajador est√° en proceso de pensi√≥n", query: "select F_RESPUESTA_A_PROCESAR, FECHA_VENCIMIENTO, ESTADO_SOLICITUD, * from ret_solicitud_saldo where nss=''", servidor: "SAFRE", acciones: { CAT: "Validar si ya se cumpli√≥ el plazo normativo, en caso de ser as√≠, levantar consulta CRM para el desmarque.", MSO: "Es necesario verificar la fecha de vigencia en el campo FECHA_VENCIMIENTO del query. Si expir√≥, solicitar desmarque mediante CRM.", UNE: "Es necesario verificar la fecha de vigencia en el campo FECHA_VENCIMIENTO. Si expir√≥, solicitar desmarque al √°rea de otorgamiento." } },
                { clave: "1270", nombre: "UNI INTRA-AFORE UNIFICADOR OP25", origen: "SAFRE", tipo: "OPERATIVA", plazo: "N/A", descripcion: "Consulta marca Operativa Op.25 posibles cuentas a unificar.", query: "select fecha_actualiza as fecha_recpecion,nss,curp,cve_ent_nss,cve_ent_curp, Case when universo=1 then '1 Unificacion Intra-Afore' end as Universo from umi_det_solicitud where curp in('')", servidor: "SAFRE", acciones: { CAT: "Si la marca est√° presente, se debe generar una consulta en CRM para su aclaraci√≥n.", MSO: "Si la marca est√° presente, se debe generar una consulta en CRM para su aclaraci√≥n.", UNE: "Se debe verificar el tipo de escenario en Universo. El proceso debe concluir en 30 d√≠as h√°biles. Si excede, consultar con Unificaci√≥n." } },
                { clave: "N/A", nombre: "RETIROS PROCESO DE RETIRO PARCIAL", origen: "PROCESAR", tipo: "OPERATIVA", plazo: "Matrimonio 90 d√≠as / Desempleo 30 d√≠as", descripcion: "Disposici√≥n de Recursos derivado de Retiro Parcial.", query: "select * from ret_parcial where nss=''", servidor: "SAFRE", acciones: { CAT: "Validar el estatus del servicio, y en caso de encontrarse rechazado o no encontrar proceso de pago, levantar consulta CRM.", MSO: "Se requiere la validaci√≥n de la fecha de vigencia en query. Si se cumple tiempo normativo, solicitar desmarque mediante CRM.", UNE: "Se requiere la validaci√≥n de la fecha de vigencia. Si se cumple el tiempo normativo, solicitar desmarque de retiros parciales." } },
                { clave: "N/A", nombre: "RETIROS TRANSFERENCIA DE RECURSOS", origen: "PROCESAR", tipo: "OPERATIVA", plazo: "5 d√≠as h√°biles", descripcion: "Transferencia al Gobierno Federal por Pensi√≥n IMSS.", query: "SELECT FECHA_CARGA_AFORE, * FROM RET_DET_DATAMART WHERE NSS=''", servidor: "SAFRE", acciones: { CAT: "Si el plazo normativo se cumple, debe levantarse una consulta a trav√©s de un folio CRM para aclaraci√≥n.", MSO: "Validar tiempo normativo de 5 d√≠as h√°biles a partir de FECHA_CARGA_AFORE. Si se cumple, levantar consulta CRM.", UNE: "Validar tiempo normativo de 5 d√≠as h√°biles a partir de FECHA_CARGA_AFORE. Solicitar desmarque con √°rea de otorgamiento." } },
                { clave: "N/A", nombre: "RETIROS PROCESO DE SALDO PREVIO IMSS", origen: "PROCESAR", tipo: "OPERATIVA", plazo: "30 d√≠as h√°biles", descripcion: "Trabajador en proceso de pensi√≥n.", query: "select * from ret_solicitud_saldo where nss=''", servidor: "SAFRE", acciones: { CAT: "Validar si ya se cumpli√≥ el plazo normativo, en caso de ser as√≠, levantar consulta CRM para el desmarque.", MSO: "Es necesario verificar la fecha de vigencia en el campo FECHA_VENCIMIENTO. Si el plazo expir√≥, solicitar desmarque mediante CRM.", UNE: "Es necesario verificar la fecha de vigencia en el campo FECHA_VENCIMIENTO. Si el plazo expir√≥, solicitar desmarque al otorgamiento." } },
                { clave: "N/A", nombre: "TRABAJADOR ASIGNADO", origen: "PROCESAR", tipo: "OPERATIVA", plazo: "Indefinido", descripcion: "Se elimina hasta que el trabajador registre el NSS", acciones: { CAT: "Informar al trabajador que se encuentra asignado en Afore Coppel e invitarlo a realizar el servicio de registro.", MSO: "Trabajador se encuentra asignado, es importante invitarlo a realizar el servicio de registro.", UNE: "Mencionar al trabajador que se encuentra asignado, es importante invitarlo a realizar su registro." } }
                // Se a√±adir√°n el resto de marcas SAFRE e IMSS con sus descripciones √≠ntegras...
            ];

            try {
                for (const item of data) {
                    const id = (item.clave && item.clave !== 'N/A') ? item.clave : item.nombre.replace(/\s+/g, '-');
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'marcas', id), item);
                }
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'access'), { key: 'GAP2024' });
                btn.innerText = '¬°Todo Arriba!';
                setTimeout(() => { loadData(); }, 1500);
            } catch (e) { btn.innerText = 'Error'; }
        }

        async function loadData() {
            try {
                const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'marcas'));
                marcasDB = snap.docs.map(x => x.data());
                renderBrands(marcasDB);
            } catch(e) { }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const authBtn = document.getElementById('auth-btn');
            const seedBtn = document.getElementById('seed-btn');
            authBtn.onclick = async () => {
                const keyIn = document.getElementById('access-key').value;
                authBtn.disabled = true; authBtn.innerText = 'Conectando...';
                try {
                    await signInAnonymously(auth);
                    const conf = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'access'));
                    if (!conf.exists() || keyIn === conf.data().key) {
                        document.getElementById('gatekeeper').classList.add('opacity-0');
                        setTimeout(() => {
                            document.getElementById('gatekeeper').style.display = 'none';
                            document.getElementById('app-content').classList.replace('hidden', 'block');
                            setTimeout(() => document.getElementById('app-content').classList.add('opacity-100'), 50);
                            loadData();
                        }, 500);
                    } else { 
                        document.getElementById('auth-error').classList.remove('hidden');
                        authBtn.disabled = false; authBtn.innerText = 'Entrar al Sistema';
                    }
                } catch (e) { 
                    document.getElementById('auth-error').classList.remove('hidden'); authBtn.disabled = false; 
                }
            };
            seedBtn.onclick = seedFirebase;
            document.getElementById('toggle-dark').onclick = () => document.documentElement.classList.toggle('dark');
            document.getElementById('search-input')?.addEventListener('input', (e) => {
                const t = e.target.value.toLowerCase();
                const c = document.querySelector('.nav-button.active')?.dataset.cat || 'all';
                renderBrands(marcasDB.filter(x => (x.nombre.toLowerCase().includes(t) || (x.clave && x.clave.toLowerCase().includes(t))) && (c === 'all' || x.tipo === c)));
            });
            document.querySelectorAll('.nav-button').forEach(b => {
                b.onclick = () => { document.querySelectorAll('.nav-button').forEach(x => x.classList.remove('active')); b.classList.add('active'); document.getElementById('search-input').dispatchEvent(new Event('input')); };
            });
        });
    </script>
</body>
</html>